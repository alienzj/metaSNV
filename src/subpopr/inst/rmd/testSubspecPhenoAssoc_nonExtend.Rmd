---
title: "TestPhenotypeAssoc"
author: "Thea Van Rossum"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
params:
  speciesID:
    value: ""
  subpopOutDir:
    value: ""
  categoryColumnName:
    value: ""
  sampleIDColumnName:
    value: ""
  metadataFile:
    value: ""
  sampleExtension:
    value: ".RepGenomesv11.sorted.bam"
---


# TO DO


decide whether to handle 1 or multiple categorical/discrete variables
decide whether to handle multiple at once (multivariate)
decide whether to handle continuous variables
load in sample technical data


```{r setup, include=FALSE}

speciesID <- params$speciesID
subpopOutDir <- params$subpopOutDir
catToAnalyse <- params$categoryColumnName
metadataFile <- params$metadataFile
sampleExtension <- params$sampleExtension
sampleIDColumnName <- params$sampleIDColumnName

# #subpopOutDir <- "/Users/rossum/Dropbox/PostDocBork/subspecies/toolDevelopment/subpopr/ES_PC/metaSNV/fr11_v1/subspec/fromServer/"
# subpopOutDir <- "/Users/rossum/Dropbox/PostDocBork/subspecies/pancreaticCancer/2018-06_data/subpopr/stoolSubspecMod/"
# speciesID <- 515620
# catToAnalyse <- "status"
# metadataFile <- "/Users/rossum/Dropbox/PostDocBork/subspecies/pancreaticCancer/2018-06_data/PC_totalmetadata_07.2018_pg1.csv"
# sampleExtension <- ".RepGenomesv11.sorted.bam"
# sampleIDColumnName <- "ID"

# subpopOutDir <- "/Users/rossum/Dropbox/PostDocBork/subspecies/pancreaticCancer/2018-06_data/v2UL/stool/subpopr/minFilter/"
#  speciesID <- 709991
#  catToAnalyse <- "status"
#  metadataFile <- "/Users/rossum/Dropbox/PostDocBork/subspecies/pancreaticCancer/2018-06_data/PC_totalmetadata_07.2018_pg1.csv"
#  sampleExtension <- ".ULRepGenomesv11.unique.sorted.bam"
#  sampleIDColumnName <- "ID"


#library(lemon) # print tables nicely in knit result without explicit call to kable()
#knit_print.data.frame <- lemon_print

library(kableExtra)

knitr::opts_chunk$set(
  echo=TRUE,
  warning=FALSE,
  error=TRUE,# keep running even if error encountered
  message=FALSE)

library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(coin)
library(questionr)
```

# Settings

```{r}

paramsDF <- data.frame(parameter = names(params),value=rep(NA,length(names(params))))
for(i in 1:length(params)){
  paramsDF[i,"value"] <- params[[i]]
}
paramsDF %>% kable() %>% kable_styling() 

```

# Load phenotype data

Using metadata file: `r metadataFile`

Analysing category: `r catToAnalyse`

```{r}
phenoDf <- read_csv(file = metadataFile,col_names = T)
phenoDfToTest <- phenoDf %>% 
  rename_("sampleName" = sampleIDColumnName) %>% 
  rename_("category" = catToAnalyse) %>% 
  select(sampleName, category) %>% 
  mutate(category = factor(category))
  
phenoDfToTest %>% kable() %>% kable_styling() %>% scroll_box(height = "200px")

```

Number of samples total in phenotype data file: `r nrow(phenoDfToTest)`

(not all samples will necessarily be tested, since they may not have subspecies assignment)

Values of categorical variable being tested: *`r paste(levels(phenoDfToTest$category),collapse = ", ")`*


# Load subspecies abundance data

```{r}

subSpecFreqDf <- read.table(paste0(subpopOutDir,speciesID,"_mann_clustering.tab"),
                            row.names = 1,as.is = T)
subSpecFreqDf$sampleName <- rownames(subSpecFreqDf) %>% 
  sub(pattern = sampleExtension, replacement = "", fixed = T)

subSpecFreqDf <- subSpecFreqDf %>% 
  mutate(clust = sub(x = clust,pattern = "^", replacement = "subspecies")) %>% 
  rename(dominantSubspecies = clust) %>% 
  mutate(dominantSubspecies = factor(dominantSubspecies,ordered = T)) %>% 
  mutate(sampleName = factor(sampleName, ordered = T))

nClus <- subSpecFreqDf$subspecies %>% unique() %>% length()
```

Number of samples with subspecies assignments: `r subSpecFreqDf$sampleName %>% unique() %>% length()`

Number of subspecies: `r nClus`

```{r}
subSpecFreqDf %>% 
  ggplot(aes(x=dominantSubspecies))+
  geom_bar() 
```

# Test for association between the dominant subspecies in a sample and the corresponding phenotype

```{r}
dfToTest <- subSpecFreqDf %>% 
  select(sampleName, dominantSubspecies) %>% 
  distinct() %>% 
  left_join(phenoDfToTest,by="sampleName") %>% 
  ungroup() %>% 
  mutate(dominantSubspecies=as.factor(dominantSubspecies))


nSamp <- dfToTest$sampleName %>% unique() %>% length()
nCat <- dfToTest$category %>% unique() %>% length()
nSubspec <- dfToTest$dominantSubspecies %>% unique() %>% length()

```

Number of samples with subspecies detected: `r length(unique(dfToTest$sampleName))`

Phenotype categories to test: `r levels(dfToTest$category)`

```{r}
table(dfToTest$category,dfToTest$dominantSubspecies) %>% 
  data.frame() %>% 
  spread(key = Var2,value = Freq) %>% 
  rename(Category = Var1) %>% kable() %>% kable_styling()
```

```{r}
dfToTest %>% 
ggplot(aes(x=dominantSubspecies,fill=dominantSubspecies))+
  geom_bar() + facet_wrap("category")+theme_bw()
```

```{r}
dfToTest %>% 
ggplot(aes(x=category,fill=dominantSubspecies))+
  geom_bar() +theme_bw()

dfToTest %>% 
ggplot(aes(x=category,fill=dominantSubspecies))+
  geom_bar(position = "fill") +theme_bw()

```


## coin
```{r}

if( length(levels(dfToTest$category)) > 1 & length(levels(dfToTest$dominantSubspecies)) >1 ){
  coin::cmh_test(category ~ dominantSubspecies , data = dfToTest)
}

```

## questionr

IS THIS THE RIGHT FAMILY???

```{r}
if( length(levels(dfToTest$category)) > 1 & length(levels(dfToTest$dominantSubspecies)) >1 ){
  reg <- glm(category ~ dominantSubspecies, data=dfToTest, family=binomial)
  questionr::odds.ratio(reg)
}

```

